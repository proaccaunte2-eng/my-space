
import React, { useState } from 'react';
import { GoogleGenAI } from "@google/genai";
import { Sparkles, Loader2, RefreshCw } from 'lucide-react';

const SoulfulPrompt: React.FC = () => {
  const [mood, setMood] = useState('');
  const [prompt, setPrompt] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const moods = [
    { id: 'tired', label: '–£—Å—Ç–∞–ª–æ—Å—Ç—å', emoji: '‚òÅÔ∏è' },
    { id: 'lost', label: '–ü–æ—Ç–µ—Ä—è–Ω–Ω–æ—Å—Ç—å', emoji: 'üß≠' },
    { id: 'anxious', label: '–¢—Ä–µ–≤–æ–≥–∞', emoji: 'üåä' },
    { id: 'hope', label: '–ù–∞–¥–µ–∂–¥–∞', emoji: 'üå±' },
  ];

  const fallbackQuestions: Record<string, string[]> = {
    '–£—Å—Ç–∞–ª–æ—Å—Ç—å': [
      "–û —á–µ–º –±—ã –ø–æ–ø—Ä–æ—Å–∏–ª–æ —Ç–≤–æ–µ —Ç–µ–ª–æ, –µ—Å–ª–∏ –±—ã —Ç—ã —Ä–∞–∑—Ä–µ—à–∏–ª–∞ –µ–º—É –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–æ—Ö–Ω—É—Ç—å —Å–µ–π—á–∞—Å?",
      "–ö–∞–∫–æ–µ –æ–¥–Ω–æ –¥–µ–ª–æ —Ç—ã –º–æ–∂–µ—à—å –æ—Ç–ª–æ–∂–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è –±–µ–∑ –º–∞–ª–µ–π—à–µ–≥–æ —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã?",
      "–ï—Å–ª–∏ –±—ã –æ—Ç–¥—ã—Ö –±—ã–ª —Ü–≤–µ—Ç–æ–º, —Ç–æ –≤ –∫–∞–∫–æ–π –æ—Ç—Ç–µ–Ω–æ–∫ —Ç–µ–±–µ —Ö–æ—á–µ—Ç—Å—è —É–∫—É—Ç–∞—Ç—å—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?"
    ],
    '–ü–æ—Ç–µ—Ä—è–Ω–Ω–æ—Å—Ç—å': [
      "–ï—Å–ª–∏ –±—ã –ª—é–±–æ–π —Ç–≤–æ–π –≤—ã–±–æ—Ä —Å–µ–≥–æ–¥–Ω—è –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º, —á—Ç–æ –±—ã —Ç—ã —Å–¥–µ–ª–∞–ª–∞ –ø–µ—Ä–≤—ã–º?",
      "–í—Å–ø–æ–º–Ω–∏ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ —Å–µ–±—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–±–æ–π. –ß—Ç–æ —Ç–∞–º –±—ã–ª–æ?",
      "–ö–∞–∫–æ–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–ø–æ–º–Ω–∏—Ç —Ç–µ–±–µ, —á—Ç–æ —Ç—ã ‚Äî —ç—Ç–æ —Ç—ã?"
    ],
    '–¢—Ä–µ–≤–æ–≥–∞': [
      "–ß—Ç–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, –≤ —ç—Ç—É —Å–µ–∫—É–Ω–¥—É, –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º –∏ –Ω–∞–¥–µ–∂–Ω—ã–º –≤–æ–∫—Ä—É–≥ —Ç–µ–±—è?",
      "–ï—Å–ª–∏ –±—ã —Ç–≤–æ—è —Ç—Ä–µ–≤–æ–≥–∞ –±—ã–ª–∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—Ö–æ–¥—è—â–∏–º –æ–±–ª–∞–∫–æ–º, –∫–∞–∫–∏–º –±—ã –æ–Ω–æ –±—ã–ª–æ?",
      "–ö–∞–∫–æ–µ —Å–ª–æ–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ç—ã –±—ã —Å–∫–∞–∑–∞–ª–∞ —Å–µ–±–µ, –µ—Å–ª–∏ –±—ã –±—ã–ª–∞ —Å–≤–æ–µ–π –ª—É—á—à–µ–π –ø–æ–¥—Ä—É–≥–æ–π?"
    ],
    '–ù–∞–¥–µ–∂–¥–∞': [
      "–ö–∞–∫–æ–π –∫—Ä–æ—à–µ—á–Ω—ã–π —Ä–æ—Å—Ç–æ–∫ —Ä–∞–¥–æ—Å—Ç–∏ —Ç—ã –∑–∞–º–µ—Ç–∏–ª–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏?",
      "–û —á–µ–º —Ç—ã –º–µ—á—Ç–∞–µ—à—å, –∫–æ–≥–¥–∞ –ø–æ–∑–≤–æ–ª—è–µ—à—å —Å–µ–±–µ –Ω–µ –¥—É–º–∞—Ç—å –æ ¬´–Ω–∞–¥–æ¬ª?",
      "–ß—Ç–æ –≤ —Ç–≤–æ–µ–º –±—É–¥—É—â–µ–º –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–≤–æ–µ —Å–µ—Ä–¥—Ü–µ –±–∏—Ç—å—Å—è —á—É—Ç—å —Ç–µ–ø–ª–µ–µ?"
    ]
  };

  const generatePrompt = async (selectedMood: string) => {
    setIsLoading(true);
    setMood(selectedMood);
    
    await new Promise(resolve => setTimeout(resolve, 1200));

    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º safe-access –¥–ª—è process.env, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å–±–æ—Ä–∫—É
      const env = (process as any).env;
      const apiKey = env ? env.API_KEY : null;

      if (apiKey && apiKey !== 'undefined' && apiKey.length > 10) {
        const ai = new GoogleGenAI({ apiKey });
        const response = await ai.models.generateContent({
          model: 'gemini-3-flash-preview',
          contents: `–ù–∞–ø–∏—à–∏ –æ–¥–∏–Ω –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π (–¥–æ 12 —Å–ª–æ–≤), –≥–ª—É–±–æ–∫–∏–π –∏ –±–µ—Ä–µ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∂–µ–Ω—â–∏–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è —Å–µ–π—á–∞—Å —á—É–≤—Å—Ç–≤—É–µ—Ç ${selectedMood}. –í–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –ø–æ–º–æ–≥–∞—Ç—å –µ–π –∑–∞–≥–ª—è–Ω—É—Ç—å –≤–Ω—É—Ç—Ä—å —Å–µ–±—è. –ë–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π.`,
        });
        setPrompt(response.text || getRandomFallback(selectedMood));
      } else {
        setPrompt(getRandomFallback(selectedMood));
      }
    } catch (error) {
      console.error("AI Error:", error);
      setPrompt(getRandomFallback(selectedMood));
    } finally {
      setIsLoading(false);
    }
  };

  const getRandomFallback = (m: string) => {
    const list = fallbackQuestions[m] || ["–û —á–µ–º –≤–∞–∂–Ω–æ–º —Ç—ã —Å–µ–≥–æ–¥–Ω—è –µ—â–µ –Ω–µ —É—Å–ø–µ–ª–∞ –ø–æ–¥—É–º–∞—Ç—å?"];
    return list[Math.floor(Math.random() * list.length)];
  };

  return (
    <section className="py-24 bg-brand-powder/20 border-y border-brand-sand/30">
      <div className="container mx-auto px-4 max-w-4xl">
        <div className="bg-white rounded-[3.5rem] p-8 md:p-16 shadow-xl border border-brand-sand/20 text-center space-y-10">
          <div className="space-y-4">
            <h2 className="text-3xl md:text-4xl font-serif italic text-brand-charcoal">–ú–∏–Ω—É—Ç–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞</h2>
            <p className="text-brand-charcoal/60 max-w-lg mx-auto leading-relaxed font-light">
              –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∞–º –±–ª–∏–∂–µ —Å–µ–π—á–∞—Å, –∏ —è –ø—Ä–µ–¥–ª–æ–∂—É –≤–æ–ø—Ä–æ—Å –¥–ª—è –±–µ—Ä–µ–∂–Ω–æ–≥–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è.
            </p>
          </div>

          <div className="flex flex-wrap justify-center gap-3 md:gap-4">
            {moods.map((m) => (
              <button
                key={m.id}
                onClick={() => generatePrompt(m.label)}
                disabled={isLoading}
                className={`px-6 py-3 rounded-full border transition-all flex items-center space-x-2 ${
                  mood === m.label 
                    ? 'bg-brand-charcoal text-white border-brand-charcoal shadow-lg' 
                    : 'bg-transparent border-brand-sand text-brand-charcoal hover:bg-brand-beige'
                } active:scale-95 disabled:opacity-50`}
              >
                <span>{m.emoji}</span>
                <span className="text-sm font-medium">{m.label}</span>
              </button>
            ))}
          </div>

          <div className="min-h-[200px] flex items-center justify-center relative bg-brand-beige/20 rounded-[2.5rem] border border-dashed border-brand-sand/40 p-8">
            {isLoading ? (
              <div className="flex flex-col items-center space-y-4">
                <Loader2 className="w-8 h-8 text-brand-dust animate-spin" />
                <p className="text-[10px] uppercase tracking-[0.2em] text-brand-dust font-bold">–ò—â—É –Ω—É–∂–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –≤–∞—Å...</p>
              </div>
            ) : prompt ? (
              <div className="space-y-6 animate-fadeIn">
                <p className="text-2xl md:text-4xl font-serif italic text-brand-charcoal leading-snug max-w-2xl mx-auto">
                  ¬´{prompt}¬ª
                </p>
                <button 
                  onClick={() => generatePrompt(mood)}
                  className="inline-flex items-center space-x-2 text-[10px] uppercase tracking-widest text-brand-dust hover:text-brand-charcoal font-bold transition-colors"
                >
                  <RefreshCw size={12} />
                  <span>–î—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å</span>
                </button>
              </div>
            ) : (
              <div className="opacity-30 flex flex-col items-center space-y-4">
                <Sparkles size={48} className="text-brand-dust" />
                <p className="text-[10px] uppercase tracking-[0.2em] font-bold">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã—à–µ</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>
  );
};

export default SoulfulPrompt;
